<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta name="google-site-verification" content="K2Exu14Kv45NN2n3fF_bBjCBgdjHvnl3zzMQ1Uz8tPk" />
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Jamie D ">
<meta name="description"
    content="The new ARM resource type Microsoft.Resources/deploymentScripts allows you to execute scripts within template deployments, capture the script outputs and re-use them later within the rest of the template.
Whilst the documentation goes some way to help you monitor and troubleshoot when the script doesn&amp;rsquo;t work as planned using the provided script service storage accounts, out of the box,I didn&amp;rsquo;t find these particularly helpful to identify why I wasn&amp;rsquo;t getting the required outputs from my inline bash script." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://jamied.me/posts/2020/12/troubleshooting-arm-deploymentscripts/" />


<title>
    
    Troubleshooting ARM DeploymentScripts :: Hello_world  ‚Äî Jamie D`
    
</title>







<link rel="stylesheet" href="https://jamied.me/main.min.2159ad286c1f8936ae0d5080ef2b39f6292ad8c1e6bcf09b3eee9f351ef0973e.css">



<link rel="apple-touch-icon" sizes="180x180" href="https://jamied.me/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jamied.me/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://jamied.me/favicon-16x16.png">
<link rel="manifest" href="https://jamied.me/site.webmanifest">
<link rel="mask-icon" href="https://jamied.me/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="https://jamied.me/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="Troubleshooting ARM DeploymentScripts">
<meta itemprop="description" content="The new ARM resource type Microsoft.Resources/deploymentScripts allows you to execute scripts within template deployments, capture the script outputs and re-use them later within the rest of the template.
Whilst the documentation goes some way to help you monitor and troubleshoot when the script doesn&rsquo;t work as planned using the provided script service storage accounts, out of the box,I didn&rsquo;t find these particularly helpful to identify why I wasn&rsquo;t getting the required outputs from my inline bash script.">


<meta itemprop="datePublished" content="2020-12-22T15:41:28&#43;00:00" />
<meta itemprop="dateModified" content="2020-12-22T15:41:28&#43;00:00" />
<meta itemprop="wordCount" content="574">



<meta itemprop="keywords" content="DevOps,Debugging deploymentScripts,ARM,Azure Resource Manager,Deployment Scripts,Bash,PowerShell," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jamied.me/post-cover.png"/>

<meta name="twitter:title" content="Troubleshooting ARM DeploymentScripts"/>
<meta name="twitter:description" content="The new ARM resource type Microsoft.Resources/deploymentScripts allows you to execute scripts within template deployments, capture the script outputs and re-use them later within the rest of the template.
Whilst the documentation goes some way to help you monitor and troubleshoot when the script doesn&rsquo;t work as planned using the provided script service storage accounts, out of the box,I didn&rsquo;t find these particularly helpful to identify why I wasn&rsquo;t getting the required outputs from my inline bash script."/>




<meta property="article:published_time" content="2020-12-22 15:41:28 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://jamied.me/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">C:\Users\daltskin</span>
            <span class="logo__cursor" style=""></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://jamied.me/about/">About</a></li><li><a href="https://jamied.me/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>3 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="https://jamied.me/posts/2020/12/troubleshooting-arm-deploymentscripts/">Troubleshooting ARM DeploymentScripts</a></h1>

            

            <div class="post-content">
                

<p>The new ARM resource type <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-script-template" target="_blank"><code>Microsoft.Resources/deploymentScripts</code></a> allows you to execute scripts within template deployments, capture the script outputs and re-use them later within the rest of the template.</p>

<p>Whilst the documentation goes some way to help you <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-script-template#monitor-and-troubleshoot-deployment-scripts" target="_blank">monitor and troubleshoot</a> when the script doesn&rsquo;t work as planned using the provided script service storage accounts, out of the box,I didn&rsquo;t find these particularly helpful to identify why I wasn&rsquo;t getting the required outputs from my inline bash script.</p>

<p>In order to help yourself debug, you&rsquo;ll need to change the <code>cleanUpPreference</code> property, the default <code>onSuccess</code> will clear down the debug contents, meaning you don&rsquo;t have anywhere to grab the output logs from.  Careful here, as <code>onSuccess</code> could just mean that your script executed ok, not necessarily that it provided the result you expected.  Here I&rsquo;m setting it to <code>onExpiration</code> to the provided <code>retentionInterval</code> period.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;properties&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 
{
  <span style="color:#f92672">&#34;forceUpdateTag&#34;</span>: <span style="color:#e6db74">&#34;[parameters(&#39;utcValue&#39;)]&#34;</span>,
  <span style="color:#f92672">&#34;AzCliVersion&#34;</span>: <span style="color:#e6db74">&#34;2.15.0&#34;</span>,
  <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;PT30M&#34;</span>,
  <span style="color:#f92672">&#34;arguments&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
  <span style="color:#f92672">&#34;scriptContent&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
  <span style="color:#f92672">&#34;cleanupPreference&#34;</span>: <span style="color:#e6db74">&#34;OnExpiration&#34;</span>,
  <span style="color:#f92672">&#34;retentionInterval&#34;</span>: <span style="color:#e6db74">&#34;P1D&#34;</span>
}</code></pre></div>
<h2 id="using-inline-scripts">Using inline scripts</h2>

<p>I&rsquo;m not usually a fan of condensing multiple lines of any script (bash/powershell) into one line, which you&rsquo;ll then need to escape, so that you can smash it into a json property within the ARM template - making it totally unreadable for your future self (or unfortunate others).  However, sometimes it makes the dev-loop quicker when you&rsquo;re still working things out with the rest of your automated deployment.</p>

<p>So, when your scriptContent doesn&rsquo;t work as planned, you&rsquo;ve triple-checked it works locally, what are you now supposed to do?  It&rsquo;s a black-hole debug experience, or so I initially thought&hellip;</p>

<h2 id="deploymentscript-artifacts">DeploymentScript artifacts</h2>

<p>As mentioned earlier, all of the script files are stored within the provided script storage account.</p>

<ul>
<li><code>azscriptinput</code>

<ul>
<li><code>DeploymentScript.sh</code> - Azure Cli deployment script execution engine uses this script to initialize context and collect outputs of user script execution</li>
<li><code>userscript.sh</code> - The contents of the scriptContent property (not very useful)</li>
</ul></li>
<li><code>azscriptoutput</code>

<ul>
<li><code>executionresult.json</code> - Execution summary of script start/end time and the overall result (half-useful)</li>
<li><code>scriptoutputs.json</code> - The json output of your bash script (only useful if the script works as intended)</li>
</ul></li>
</ul>

<h2 id="deploymentscript-json-outputs">DeploymentScript json outputs</h2>

<p>As per the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-script-template?tabs=CLI#work-with-outputs-from-cli-script" target="_blank">documentation</a> your bash script MUST output json conforming to the following schema:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;result&#34;</span>: {
    <span style="color:#f92672">&#34;property1&#34;</span>: <span style="color:#e6db74">&#34;value&#34;</span>,
    <span style="color:#f92672">&#34;property2&#34;</span>: <span style="color:#e6db74">&#34;value&#34;</span>
  }
}</code></pre></div>
<p>And within your ARM template outputs you need to reference this output values like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;outputs&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
    <span style="color:#f92672">&#34;Property1OutputVar&#34;</span>: {
        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;[reference(&#39;runBashWithOutputs&#39;).outputs.result.property1]&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
    },
    <span style="color:#f92672">&#34;Property2OutputVar&#34;</span>: {
        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;[reference(&#39;runBashWithOutputs&#39;).outputs.result.property2]&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
    }        
}</code></pre></div>
<p>In my case, my inline script was executing successfully, but my actual values were empty:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;result&#34;</span>: {
    <span style="color:#f92672">&#34;appId&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
    <span style="color:#f92672">&#34;appSecret&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
  }
}</code></pre></div>
<h2 id="az-scripts-path-output-directory">AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY</h2>

<p>Time to add some debugging into our script, but how can we do that?  Looking in the <code>DeploymentScript.sh</code> mentioned above, you&rsquo;ll find a bunch of other variables, one of which is <code>AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY</code>, so we can use this location to dump any of our custom script outputs to üòÄ</p>

<p>So by doing the following in the inline script, we can now add some tracing inside the script, and the output will be moved into the storage account with the rest of the outputs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;properties&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> 
{
  <span style="color:#f92672">&#34;AzCliVersion&#34;</span>: <span style="color:#e6db74">&#34;2.15.0&#34;</span>,
  <span style="color:#f92672">&#34;forceUpdateTag&#34;</span>: <span style="color:#e6db74">&#34;[parameters(&#39;utcValue&#39;)]&#34;</span>,
  <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;PT30M&#34;</span>,
  <span style="color:#f92672">&#34;arguments&#34;</span>: <span style="color:#e6db74">&#34;[parameters(&#39;appName&#39;)]&#34;</span>,
  <span style="color:#f92672">&#34;scriptContent&#34;</span>: <span style="color:#e6db74">&#34;appName=$1; echo $appName &gt; $AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY/app; echo $(az¬†account¬†list) &gt; $AZ_SCRIPTS_PATH_OUTPUT_DIRECTORY/account; ...&lt;rest of script has been removed&gt;&#34;</span>,
  <span style="color:#f92672">&#34;cleanupPreference&#34;</span>: <span style="color:#e6db74">&#34;OnExpiration&#34;</span>,
  <span style="color:#f92672">&#34;retentionInterval&#34;</span>: <span style="color:#e6db74">&#34;P1D&#34;</span>
}</code></pre></div>
<p>Here you can see I&rsquo;m dumping both the input appName parameter value and the output from the <code>az account list</code> command to different files in the script storage output:</p>

<p><img src="https://jamied.me/img/deploymentscript.png" width="800"></p>

<p>Hope this helps others.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://jamied.me/tags/devops">DevOps</a></span><span class="tag"><a href="https://jamied.me/tags/debugging-deploymentscripts">Debugging deploymentScripts</a></span><span class="tag"><a href="https://jamied.me/tags/arm">ARM</a></span><span class="tag"><a href="https://jamied.me/tags/azure-resource-manager">Azure Resource Manager</a></span><span class="tag"><a href="https://jamied.me/tags/deployment-scripts">Deployment Scripts</a></span><span class="tag"><a href="https://jamied.me/tags/bash">Bash</a></span><span class="tag"><a href="https://jamied.me/tags/powershell">PowerShell</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>574 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-12-22 15:41 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://jamied.me/posts/2020/12/smart-home-multiplayer-bomb-disposal-game-/-escape-room/">
                                <span class="button__icon">‚Üê</span>
                                <span class="button__text">Smart Home Multiplayer Bomb Disposal Game / Escape Room</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://jamied.me/posts/2020/08/github-webhooks-with-azure-functions-and-smartthings/">
                                <span class="button__text">GitHub Webhooks With Azure Functions and SmartThings</span>
                                <span class="button__icon">‚Üí</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
                <span><a href="https://jamied.me/">Jamie D</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://jamied.me/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Hugo theme by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://jamied.me/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>
    <script type="text/javascript">
        var sdkInstance="appInsightsSDK";window[sdkInstance]="appInsights";var aiName=window[sdkInstance],aisdk=window[aiName]||function(e){function n(e){t[e]=function(){var n=arguments;t.queue.push(function(){t[e].apply(t,n)})}}var t={config:e};t.initialize=!0;var i=document,a=window;setTimeout(function(){var n=i.createElement("script");n.src=e.url||"https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js",i.getElementsByTagName("script")[0].parentNode.appendChild(n)});try{t.cookie=i.cookie}catch(e){}t.queue=[],t.version=2;for(var r=["Event","PageView","Exception","Trace","DependencyData","Metric","PageViewPerformance"];r.length;)n("track"+r.pop());n("startTrackPage"),n("stopTrackPage");var s="Track"+r[0];if(n("start"+s),n("stop"+s),n("setAuthenticatedUserContext"),n("clearAuthenticatedUserContext"),n("flush"),!(!0===e.disableExceptionTracking||e.extensionConfig&&e.extensionConfig.ApplicationInsightsAnalytics&&!0===e.extensionConfig.ApplicationInsightsAnalytics.disableExceptionTracking)){n("_"+(r="onerror"));var o=a[r];a[r]=function(e,n,i,a,s){var c=o&&o(e,n,i,a,s);return!0!==c&&t["_"+r]({message:e,url:n,lineNumber:i,columnNumber:a,error:s}),c},e.autoExceptionInstrumented=!0}return t}(
        {
        instrumentationKey:"490dec9c-4d14-4f46-9054-0d119b76a14d"
        }
        );window[aiName]=aisdk,aisdk.queue&&0===aisdk.queue.length&&aisdk.trackPageView({});
    </script>



    </body>
</html>
